{
    "Name": "Battery Dispatch Options BTM",
    "Width": 1056.0,
    "Height": 232.0,
    "FormObjects": {
        "CheckBox": {
            "Visible": 1.0,
            "ObjectProperties": {
                "Name": {
                    "Type": 5.0,
                    "String": "batt_dispatch_auto_btm_can_discharge_to_grid"
                },
                "X": {
                    "Type": 3.0,
                    "Integer": 309.0
                },
                "Y": {
                    "Type": 3.0,
                    "Integer": 123.0
                },
                "Width": {
                    "Type": 3.0,
                    "Integer": 415.0
                },
                "Height": {
                    "Type": 3.0,
                    "Integer": 21.0
                },
                "Tool Tip": {
                    "Type": 5.0,
                    "String": ""
                },
                "Caption": {
                    "Type": 5.0,
                    "String": "Battery can discharge to grid"
                },
                "State": {
                    "Type": 2.0,
                    "Boolean": 1.0
                },
                "TabOrder": {
                    "Type": 3.0,
                    "Integer": 7.0
                }
            }
        },
        "CheckBox": {
            "Visible": 1.0,
            "ObjectProperties": {
                "Name": {
                    "Type": 5.0,
                    "String": "batt_dispatch_auto_can_charge"
                },
                "X": {
                    "Type": 3.0,
                    "Integer": 309.0
                },
                "Y": {
                    "Type": 3.0,
                    "Integer": 81.0
                },
                "Width": {
                    "Type": 3.0,
                    "Integer": 415.0
                },
                "Height": {
                    "Type": 3.0,
                    "Integer": 21.0
                },
                "Tool Tip": {
                    "Type": 5.0,
                    "String": ""
                },
                "Caption": {
                    "Type": 5.0,
                    "String": "Battery can charge from system"
                },
                "State": {
                    "Type": 2.0,
                    "Boolean": 1.0
                },
                "TabOrder": {
                    "Type": 3.0,
                    "Integer": 7.0
                }
            }
        },
        "CheckBox": {
            "Visible": 1.0,
            "ObjectProperties": {
                "Name": {
                    "Type": 5.0,
                    "String": "batt_dispatch_auto_can_clipcharge"
                },
                "X": {
                    "Type": 3.0,
                    "Integer": 309.0
                },
                "Y": {
                    "Type": 3.0,
                    "Integer": 102.0
                },
                "Width": {
                    "Type": 3.0,
                    "Integer": 415.0
                },
                "Height": {
                    "Type": 3.0,
                    "Integer": 21.0
                },
                "Tool Tip": {
                    "Type": 5.0,
                    "String": ""
                },
                "Caption": {
                    "Type": 5.0,
                    "String": "Battery can charge from clipped system power"
                },
                "State": {
                    "Type": 2.0,
                    "Boolean": 1.0
                },
                "TabOrder": {
                    "Type": 3.0,
                    "Integer": 7.0
                }
            }
        },
        "CheckBox": {
            "Visible": 1.0,
            "ObjectProperties": {
                "Name": {
                    "Type": 5.0,
                    "String": "batt_dispatch_auto_can_fuelcellcharge"
                },
                "X": {
                    "Type": 3.0,
                    "Integer": 309.0
                },
                "Y": {
                    "Type": 3.0,
                    "Integer": 192.0
                },
                "Width": {
                    "Type": 3.0,
                    "Integer": 415.0
                },
                "Height": {
                    "Type": 3.0,
                    "Integer": 21.0
                },
                "Tool Tip": {
                    "Type": 5.0,
                    "String": ""
                },
                "Caption": {
                    "Type": 5.0,
                    "String": "Battery can charge from fuel cell"
                },
                "State": {
                    "Type": 2.0,
                    "Boolean": 1.0
                },
                "TabOrder": {
                    "Type": 3.0,
                    "Integer": 8.0
                }
            }
        },
        "CheckBox": {
            "Visible": 1.0,
            "ObjectProperties": {
                "Name": {
                    "Type": 5.0,
                    "String": "batt_dispatch_auto_can_gridcharge"
                },
                "X": {
                    "Type": 3.0,
                    "Integer": 309.0
                },
                "Y": {
                    "Type": 3.0,
                    "Integer": 60.0
                },
                "Width": {
                    "Type": 3.0,
                    "Integer": 415.0
                },
                "Height": {
                    "Type": 3.0,
                    "Integer": 21.0
                },
                "Tool Tip": {
                    "Type": 5.0,
                    "String": ""
                },
                "Caption": {
                    "Type": 5.0,
                    "String": "Battery can charge from grid"
                },
                "State": {
                    "Type": 2.0,
                    "Boolean": 1.0
                },
                "TabOrder": {
                    "Type": 3.0,
                    "Integer": 6.0
                }
            }
        },
        "CheckBox": {
            "Visible": 1.0,
            "ObjectProperties": {
                "Name": {
                    "Type": 5.0,
                    "String": "batt_dispatch_charge_only_system_exceeds_load"
                },
                "X": {
                    "Type": 3.0,
                    "Integer": 309.0
                },
                "Y": {
                    "Type": 3.0,
                    "Integer": 144.0
                },
                "Width": {
                    "Type": 3.0,
                    "Integer": 415.0
                },
                "Height": {
                    "Type": 3.0,
                    "Integer": 24.0
                },
                "Tool Tip": {
                    "Type": 5.0,
                    "String": ""
                },
                "Caption": {
                    "Type": 5.0,
                    "String": "Charge from system only when system output exceeds load"
                },
                "State": {
                    "Type": 2.0,
                    "Boolean": 1.0
                },
                "TabOrder": {
                    "Type": 3.0,
                    "Integer": -1.0
                }
            }
        },
        "RadioChoice": {
            "Visible": 1.0,
            "ObjectProperties": {
                "Name": {
                    "Type": 5.0,
                    "String": "batt_dispatch_choice_ui"
                },
                "X": {
                    "Type": 3.0,
                    "Integer": 15.0
                },
                "Y": {
                    "Type": 3.0,
                    "Integer": 60.0
                },
                "Width": {
                    "Type": 3.0,
                    "Integer": 288.0
                },
                "Height": {
                    "Type": 3.0,
                    "Integer": 114.0
                },
                "Tool Tip": {
                    "Type": 5.0,
                    "String": ""
                },
                "Selection": {
                    "Type": 3.0,
                    "Integer": 0.0
                },
                "Items": {
                    "Type": 6.0,
                    "StringList": "Peak shaving|Input grid power targets|Input battery power targets|Manual dispatch|Price signal forecast"
                },
                "ShowCaptions": {
                    "Type": 2.0,
                    "Boolean": 1.0
                },
                "Horizontal": {
                    "Type": 2.0,
                    "Boolean": 0.0
                },
                "TabOrder": {
                    "Type": 3.0,
                    "Integer": 1.0
                }
            }
        },
        "CheckBox": {
            "Visible": 1.0,
            "ObjectProperties": {
                "Name": {
                    "Type": 5.0,
                    "String": "batt_dispatch_discharge_only_load_exceeds_system"
                },
                "X": {
                    "Type": 3.0,
                    "Integer": 309.0
                },
                "Y": {
                    "Type": 3.0,
                    "Integer": 168.0
                },
                "Width": {
                    "Type": 3.0,
                    "Integer": 415.0
                },
                "Height": {
                    "Type": 3.0,
                    "Integer": 24.0
                },
                "Tool Tip": {
                    "Type": 5.0,
                    "String": ""
                },
                "Caption": {
                    "Type": 5.0,
                    "String": "Discharge battery only when load exceeds system output"
                },
                "State": {
                    "Type": 2.0,
                    "Boolean": 1.0
                },
                "TabOrder": {
                    "Type": 3.0,
                    "Integer": -1.0
                }
            }
        },
        "Label": {
            "Visible": 1.0,
            "ObjectProperties": {
                "Name": {
                    "Type": 5.0,
                    "String": "lbl_btm_warning_message"
                },
                "X": {
                    "Type": 3.0,
                    "Integer": 726.0
                },
                "Y": {
                    "Type": 3.0,
                    "Integer": 60.0
                },
                "Width": {
                    "Type": 3.0,
                    "Integer": 315.0
                },
                "Height": {
                    "Type": 3.0,
                    "Integer": 147.0
                },
                "Tool Tip": {
                    "Type": 5.0,
                    "String": ""
                },
                "Caption": {
                    "Type": 5.0,
                    "String": ""
                },
                "TextColour": {
                    "Type": 4.0,
                    "Color": {
                        "Red": 0.0,
                        "Green": 0.0,
                        "Blue": 0.0,
                        "Alpha": 255.0
                    }
                },
                "Bold": {
                    "Type": 2.0,
                    "Boolean": 0.0
                },
                "FontSize": {
                    "Type": 3.0,
                    "Integer": 0.0
                },
                "WordWrap": {
                    "Type": 2.0,
                    "Boolean": 1.0
                },
                "AlignRight": {
                    "Type": 2.0,
                    "Boolean": 0.0
                },
                "AlignTop": {
                    "Type": 2.0,
                    "Boolean": 1.0
                }
            }
        },
        "Label": {
            "Visible": 1.0,
            "ObjectProperties": {
                "Name": {
                    "Type": 5.0,
                    "String": "lbl_dispatch_options"
                },
                "X": {
                    "Type": 3.0,
                    "Integer": 15.0
                },
                "Y": {
                    "Type": 3.0,
                    "Integer": 21.0
                },
                "Width": {
                    "Type": 3.0,
                    "Integer": 918.0
                },
                "Height": {
                    "Type": 3.0,
                    "Integer": 36.0
                },
                "Tool Tip": {
                    "Type": 5.0,
                    "String": ""
                },
                "Caption": {
                    "Type": 5.0,
                    "String": ""
                },
                "TextColour": {
                    "Type": 4.0,
                    "Color": {
                        "Red": 0.0,
                        "Green": 0.0,
                        "Blue": 0.0,
                        "Alpha": 255.0
                    }
                },
                "Bold": {
                    "Type": 2.0,
                    "Boolean": 0.0
                },
                "FontSize": {
                    "Type": 3.0,
                    "Integer": 0.0
                },
                "WordWrap": {
                    "Type": 2.0,
                    "Boolean": 1.0
                },
                "AlignRight": {
                    "Type": 2.0,
                    "Boolean": 0.0
                },
                "AlignTop": {
                    "Type": 2.0,
                    "Boolean": 1.0
                }
            }
        },
        "GroupBox": {
            "Visible": 1.0,
            "ObjectProperties": {
                "Name": {
                    "Type": 5.0,
                    "String": "object 4"
                },
                "X": {
                    "Type": 3.0,
                    "Integer": 6.0
                },
                "Y": {
                    "Type": 3.0,
                    "Integer": 3.0
                },
                "Width": {
                    "Type": 3.0,
                    "Integer": 1042.0
                },
                "Height": {
                    "Type": 3.0,
                    "Integer": 218.0
                },
                "Tool Tip": {
                    "Type": 5.0,
                    "String": ""
                },
                "Caption": {
                    "Type": 5.0,
                    "String": "Behind-the-meter (BTM) Storage Dispatch Options"
                },
                "Bold": {
                    "Type": 2.0,
                    "Boolean": 1.0
                }
            }
        }
    },
    "VarDatabase": {
        "batt_dispatch_auto_btm_can_discharge_to_grid": {
            "Version": 4.0,
            "Type": 1.0,
            "Label": "Battery can discharge to grid",
            "Units": " ",
            "Group": "Battery Dispatch",
            "IndexLabels": "",
            "Flags": 3.0,
            "DefaultValue": 0.0,
            "UIObject": "CheckBox",
            "sscVariableName": "",
            "sscVariableValue": ""
        },
        "batt_dispatch_auto_can_charge": {
            "Version": 4.0,
            "Type": 1.0,
            "Label": "Battery can charge from power generation",
            "Units": " ",
            "Group": "Battery Dispatch",
            "IndexLabels": "",
            "Flags": 3.0,
            "DefaultValue": 0.0,
            "UIObject": "CheckBox",
            "sscVariableName": "",
            "sscVariableValue": ""
        },
        "batt_dispatch_auto_can_clipcharge": {
            "Version": 4.0,
            "Type": 1.0,
            "Label": "DC connected battery can charge from clipped power",
            "Units": " ",
            "Group": "Battery Dispatch",
            "IndexLabels": "",
            "Flags": 3.0,
            "DefaultValue": 0.0,
            "UIObject": "CheckBox",
            "sscVariableName": "",
            "sscVariableValue": ""
        },
        "batt_dispatch_auto_can_fuelcellcharge": {
            "Version": 4.0,
            "Type": 1.0,
            "Label": "Battery can charge from fuel cell",
            "Units": " ",
            "Group": "Battery Dispatch",
            "IndexLabels": "",
            "Flags": 3.0,
            "DefaultValue": 0.0,
            "UIObject": "CheckBox",
            "sscVariableName": "",
            "sscVariableValue": ""
        },
        "batt_dispatch_auto_can_gridcharge": {
            "Version": 4.0,
            "Type": 1.0,
            "Label": "Battery can charge from grid",
            "Units": " ",
            "Group": "Battery Dispatch",
            "IndexLabels": "",
            "Flags": 3.0,
            "DefaultValue": 0.0,
            "UIObject": "CheckBox",
            "sscVariableName": "",
            "sscVariableValue": ""
        },
        "batt_dispatch_charge_only_system_exceeds_load": {
            "Version": 4.0,
            "Type": 1.0,
            "Label": "Power flow constraint for only charging when system exceeds load",
            "Units": " ",
            "Group": "Battery Dispatch",
            "IndexLabels": "",
            "Flags": 3.0,
            "DefaultValue": 1.0,
            "UIObject": "CheckBox",
            "sscVariableName": "",
            "sscVariableValue": ""
        },
        "batt_dispatch_choice_ui": {
            "Version": 4.0,
            "Type": 1.0,
            "Label": "Battery dispatch options BTM",
            "Units": " ",
            "Group": "Battery Dispatch",
            "IndexLabels": "Peak shaving|Input grid power targets|Input battery power targets|Manual dispatch|Price signal forecast",
            "Flags": 3.0,
            "DefaultValue": 0.0,
            "UIObject": "RadioChoice",
            "sscVariableName": "",
            "sscVariableValue": ""
        },
        "batt_dispatch_discharge_only_load_exceeds_system": {
            "Version": 4.0,
            "Type": 1.0,
            "Label": "Power flow constraint for battery discharge only when load exceeds system power",
            "Units": " ",
            "Group": "Battery Dispatch",
            "IndexLabels": "",
            "Flags": 3.0,
            "DefaultValue": 1.0,
            "UIObject": "CheckBox",
            "sscVariableName": "",
            "sscVariableValue": ""
        },
        "batt_dispatch_load_forecast_choice": {
            "Version": 4.0,
            "Type": 1.0,
            "Label": "Selects the load forecast used by battery dispatch",
            "Units": " ",
            "Group": "Battery Dispatch",
            "IndexLabels": "",
            "Flags": 0.0,
            "DefaultValue": 0.0,
            "UIObject": "Default",
            "sscVariableName": "",
            "sscVariableValue": ""
        },
        "batt_dispatch_wf_forecast_choice": {
            "Version": 4.0,
            "Type": 1.0,
            "Label": "Selects the generation forecast used by battery dispatch",
            "Units": " ",
            "Group": "Battery Dispatch",
            "IndexLabels": "",
            "Flags": 0.0,
            "DefaultValue": 0.0,
            "UIObject": "Default",
            "sscVariableName": "",
            "sscVariableValue": ""
        },
        "batt_load_ac_forecast": {
            "Version": 4.0,
            "Type": 2.0,
            "Label": "Load forecast used in battery dispatch",
            "Units": "kW",
            "Group": "Battery Dispatch",
            "IndexLabels": "",
            "Flags": 8.0,
            "DefaultValue": [
                0.0
            ],
            "UIObject": "Default",
            "sscVariableName": "",
            "sscVariableValue": ""
        },
        "batt_load_ac_forecast_escalation": {
            "Version": 4.0,
            "Type": 2.0,
            "Label": "Load escalation percent used in battery dispatch",
            "Units": "%/yr",
            "Group": "Battery Dispatch",
            "IndexLabels": "",
            "Flags": 8.0,
            "DefaultValue": [
                0.0
            ],
            "UIObject": "Default",
            "sscVariableName": "",
            "sscVariableValue": ""
        }
    },
    "Equations": "equations{'batt_load_ac_forecast'} = define()\n{\n\tif(${batt_dispatch_load_forecast_choice} == 2) {\n\t\tchoice = ${batt_dispatch_choice_ui};\n\t\tif (choice == 0) {\n\t\t\treturn ${load_user_forecast_data_peak_shaving};\n\t\t}\n\t\telse if (choice == 4) {\n\t\t\treturn ${load_user_forecast_data_psd};\n\t\t}\n\t\telse {\n\t\t\treturn [0];\n\t\t}\n\t}\n\telse {\n\t\treturn [0];\n\t}\n};\n\nequations{'batt_load_ac_forecast_escalation'} = define()\n{\n\tif(${batt_dispatch_load_forecast_choice} == 2) {\n\t\tchoice = ${batt_dispatch_choice_ui};\n\t\tif (choice == 0) {\n\t\t\tif (${batt_dispatch_load_escal_choice_peak} == 1) {\n\t\t\t\treturn ${batt_dispatch_load_forecast_escal_psd};\n\t\t\t}\n\t\t\telse {\n\t\t\t\treturn ${load_escalation};\n\t\t\t}\n\t\t}\n\t\telse if (choice == 4) {\n\t\t\tif (${batt_dispatch_load_escal_choice_psd} == 1) {\n\t\t\t\treturn ${batt_dispatch_load_forecast_escal_psd};\n\t\t\t}\n\t\t\telse {\n\t\t\t\treturn ${load_escalation};\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\t//logmsg(\"Setting batt_load_ac_forecast to 0\");\n\t\t\treturn [0];\n\t\t}\n\t}\n\telse {\n\t\treturn [0];\n\t}\n};",
    "Callbacks": "on_load{'Battery Dispatch Options BTM'} = define() {\n\tshow_hide_charge_options();\n\tenable_disable_powerflow_options();\n\tenable_charge_from_clip();\n\tenable_charging_priority();\n\tif ( technology() == 'Fuel Cell' && value('en_batt') == 0 )\n\t{ \n\t\tmsg = 'Battery storage is not enabled. Enable battery on Battery Storage page before setting storage dispatch options.';\n\t\tclr = 'red';\n\t}\n\telse\n\t{\n\t\tmsg = 'The storage dispatch options determine how and when the battery charges and discharges. Choose an option below and then provide the dispatch details as appropriate.';\n\t\tclr = 'black';\n\t}\n\tproperty('lbl_dispatch_options','Caption',msg);\n\tproperty('lbl_dispatch_options','TextColour',clr);\n};\n\non_change{'batt_dispatch_choice_ui'} = define() \n{\n\tshow_hide_charge_options();\n\tenable_charge_from_clip();\n\tenable_disable_powerflow_options();\n\tenable_charging_priority();\n\tif ( technology() == 'Fuel Cell' )\n\t{\n\t\tcheck_fuel_cell_dispatch(); // defined in Fuel Cell Dispatch callback\n\t}\n\tvalue('batt_dispatch_excl', value('batt_dispatch_choice_ui'));\n};\n\non_change{'batt_dispatch_auto_can_charge'} = define() {\n\tenable_disable_powerflow_options();\n};\n\n// Only allow system charge priority options when this is unchecked\non_change{'batt_dispatch_charge_only_system_exceeds_load'} = define() {\n\tenable_charging_priority();\n};\n\nfunction enable_charging_priority() {\n\tcharge_system_first = value('batt_dispatch_charge_only_system_exceeds_load');\n\tenable('dispatch_manual_system_charge_first', !charge_system_first);\n\tenable('lbl_pv_priority', !charge_system_first);\n\trefresh();\n}\n\n// hide charge options for manual dispatch\nfunction show_hide_charge_options()\n{\n\tif ( technology() == 'Fuel Cell' && value('en_batt') == 0  )\n\t{ \n\t\tenable('batt_dispatch_choice_ui',false); \n\t\t//Peak Shaving Inputs\n\t\tenable('peak_shaving_batt_dispatch_choice', false);\n\t\t//Input Grid Power Targets Inputs\n\t\tenable('batt_target_choice', false);\n\t\tenable('batt_target_power', false);\n\t\tenable('batt_target_power_monthly', false);\n\t\t//Input Battery Power Targets Inputs\n\t\tenable('batt_custom_dispatch', false);\n\t\t//Price Signal Dispatch Inputs\n\t\tenable('batt_cycle_cost', false);\n\t\tenable('batt_cycle_cost_choice', false);\n\t\tenable('batt_dispatch_auto_btm_can_discharge_to_grid', false);\n\n\t}\n\telse\n\t{\n\t\toption = value('batt_dispatch_choice_ui');\n\t\tenable('batt_dispatch_auto_can_charge',option != 3);\n\t\tenable('batt_dispatch_auto_can_gridcharge', option !=3);\n\t\tenable('batt_dispatch_auto_btm_can_discharge_to_grid', option == 2);\n\t\tshow('batt_dispatch_auto_can_fuelcellcharge', option !=3 && technology() == 'Fuel Cell' );\n\t\trefresh();\n\t}\n}\n\nfunction enable_disable_powerflow_options()\n{\n\t// enable exceeds load exceeds output option only for AC-connected batteries\n\t// for DC-connected batteries disable and set to false\n\tif ( technology() == 'Fuel Cell' && value('en_batt') == 0 )\n\t{ \n\t\tenable('batt_dispatch_charge_only_system_exceeds_load', false);\n\t\tenable('batt_dispatch_discharge_only_load_exceeds_system', false);\n\t}\n\telse if (value('batt_ac_or_dc') == 0) { // DC-connected\n\t\tvalue('batt_dispatch_charge_only_system_exceeds_load', 0);\n\t\tenable('batt_dispatch_charge_only_system_exceeds_load', false);\n\t\tvalue('batt_dispatch_discharge_only_load_exceeds_system', true);\n\t}\n\telse {\n\t\tenable('batt_dispatch_charge_only_system_exceeds_load', true);\n\t\tenable('batt_dispatch_discharge_only_load_exceeds_system', true);\n\t}\n}\n\nfunction enable_charge_from_clip()\n{\n\t// enable charge from clipped power if dc-connected and automated dispatch\n\tis_dc = (value('batt_ac_or_dc' ) == 0);\n\tif ( is_dc && (value('batt_dispatch_choice_ui') == 3 || (value('batt_dispatch_choice_ui') == 4)))\n\t{ enable('batt_dispatch_auto_can_clipcharge', true); }\n\telse \n\t{ \n\t\tenable('batt_dispatch_auto_can_clipcharge',false);\n\t\tproperty('batt_dispatch_auto_can_clipcharge','State', 0);\n\t} \n\tbtm_warning_message();\n}\n\nfunction btm_warning_message() \n{\n\tis_dc = (value('batt_ac_or_dc' ) == 0);\n\tcolor = 'black';\n\tif ( is_dc )\n\t{\n\t\tmsg = 'Battery is DC-connected. The Charge From System Only When System Output Exceeds Load option is only available for AC-connected systems. Charging from clipped system power is only available for Price Signal Forecast and Manual dispatch options.'; \n\t}\n\telse\n\t{ \n\t\tmsg = 'Battery is AC-connected. Charging from clipped power is only available for DC-connected batteries. See input under Power Converters on Battery Cell and System page.'; \n\t}\n\tmsg += ' See input under Power Converters on Battery Cell and System page.';\n\tproperty('lbl_btm_warning_message','Caption',msg);\n\tproperty('lbl_btm_warning_message','TextColour',color);\n}\n"
}